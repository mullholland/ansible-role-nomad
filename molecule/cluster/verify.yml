---
- name: Verify
  hosts: all
  become: true
  gather_facts: true

  tasks:
    - name: SmokeTests
      ansible.builtin.debug:
        msg:
          - "ansible_version => {{ansible_version}}"
          - "ansible_distribution => {{ ansible_distribution }}"
          - "ansible_distribution_major_version => {{ ansible_distribution_major_version }}"
          - "ansible_os_family  => {{ ansible_os_family}}"
          - "ansible_system  => {{ ansible_system }}"

    - name: Check nomad package is installed
      ansible.builtin.package:
        name: "nomad"
        state: present
      check_mode: true
      register: package_installed
      failed_when: (package_installed is changed) or (package_installed is failed)

    - name: check /etc/nomad.d/nomad.hcl conf file
      lineinfile:
        name: "/etc/nomad.d/nomad.hcl"
        line: "# Ansible managed: Do NOT edit this file manually!"
        state: present
        owner: "nomad"
        group: "nomad"
        mode: "0640"
      check_mode: true
      register: molecule_hcl
      failed_when: (molecule_hcl is changed) or (molecule_hcl is failed)

    # - name: check /etc/nomad.d/nomad.env file
    #   lineinfile:
    #     name: "/etc/nomad.d/nomad.env"
    #     line: "# Ansible managed: Do NOT edit this file manually!"
    #     state: present
    #     owner: "nomad"
    #     group: "nomad"
    #     mode: "0640"
    #   check_mode: true
    #   register: molecule_env
    #   failed_when: (molecule_env is changed) or (molecule_env is failed)

    - name: check nomad daemon
      service:
        name: "nomad"
        state: started
        enabled: true
      check_mode: true
      register: molecule_service
      failed_when: (molecule_service is changed) or (molecule_service is failed)

    - name: nomad API reachable?
      uri:
        url: "http://localhost:4646/v1/metrics"
        method: GET
        status_code: 200
        body_format: json
      register: check_result
      retries: 6
      until: check_result is succeeded
      delay: 10
      changed_when: false
